<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>AI Copilot ‚Äî Prompt to Report</title>

    <!-- ChartJS -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- html2pdf -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>

    <style>
        body {
            margin: 0;
            padding: 0;
            background: #F5F7FA;
            font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto;
        }

        /* LSQ NAVBAR ‚Äî Reduced height & NO logo */
        .lsq-navbar {
            background: #ffffff;
            padding: 6px 24px;
            height: 12px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.06);
        }

        /* BLUE HEADER */
        .header-strip {
            width: 100%;
            background: #1564FF;
            color: white;
            padding: 18px 28px;
            font-size: 20px;
            font-weight: 600;
        }

        /* MAIN LAYOUT */
        .main-layout {
            display: flex;
            height: calc(100vh - 110px);
        }

        /* LEFT PANEL */
        .left-panel {
            width: 270px;
            background: white;
            border-right: 1px solid #E4E7EC;
            padding: 20px 16px;
            overflow-y: auto;
        }

        .left-title {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .prompt-item {
            background: #F3F6FC;
            padding: 10px 12px;
            border-radius: 6px;
            margin-bottom: 8px;
            cursor: pointer;
        }

        .prompt-item:hover { background: #e7eeff; }

        /* CONTENT AREA */
        .content-area {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }

        /* INPUT ROW */
        .input-row {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }

        #prompt {
            width: 100%;
            padding: 14px;
            border-radius: 8px;
            border: 1px solid #D0D5DD;
        }

        #generateBtn {
            background: #1564FF;
            color: white;
            border: none;
            padding: 0 22px;
            border-radius: 8px;
            cursor: pointer;
        }

        /* TOOLBAR */
        .toolbar {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-bottom: 12px;
        }

        .toolbar button {
            padding: 8px 18px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
        }

        .btn-reset { background: #E4E7EC; }
        .btn-pdf { background: #1564FF; color: white; }

        /* REPORT BOX */
        .report-box {
            background: white;
            border-radius: 10px;
            padding: 28px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.07);
        }

        .section-title {
            font-size: 17px;
            font-weight: 600;
            margin-top: 20px;
        }

        .metric-item {
            padding: 10px;
            background: #F9FAFB;
            border-radius: 6px;
            border: 1px solid #E4E7EC;
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
        }

        /* SHIMMER LOADER */
        .shimmer {
            height: 120px;
            border-radius: 8px;
            background: linear-gradient(90deg, #f0f0f0 0%, #e4e4e4 50%, #f0f0f0 100%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            margin-bottom: 20px;
        }

        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* ‚≠ê FIXED CHART SIZE ‚≠ê */
        .chart-wrapper {
            width: 420px;
            height: 420px;
            margin: 25px auto;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #chart {
            max-width: 420px !important;
            max-height: 420px !important;
        }
    </style>
</head>

<body>

    <div class="lsq-navbar"></div>

    <div class="header-strip">AI Copilot ‚Äî Prompt to Report</div>

    <div class="main-layout">

        <!-- LEFT PANEL -->
        <div class="left-panel">
            <div class="left-title">Recent Prompts</div>
            <div id="recentList"></div>
        </div>

        <!-- MAIN CONTENT -->
        <div class="content-area">

            <!-- INPUT -->
            <div class="input-row">
                <input id="prompt" placeholder="e.g. Show leakage by provider for last 3 months">
                <button id="generateBtn">Generate</button>
            </div>

            <!-- TOOLBAR -->
            <div class="toolbar">
                <button class="btn-reset" id="resetBtn">Reset</button>
                <button class="btn-pdf" id="pdfBtn">Download PDF</button>
            </div>

            <!-- LOADER -->
            <div id="loader" style="display:none;">
                <div class="shimmer"></div>
                <div class="shimmer" style="height: 80px;"></div>
            </div>

            <!-- REPORT -->
            <div id="reportArea"></div>

        </div>
    </div>

<script>
/*************************************************
   CONFIG
*************************************************/
const n8nWebhook = "https://leadsquared.app.n8n.cloud/webhook/38fe1165-731f-438b-81df-5bc5de35481c";

/*************************************************
   RECENT PROMPTS
*************************************************/
function loadRecent() {
    const list = JSON.parse(localStorage.getItem("recentPrompts") || "[]");
    const div = document.getElementById("recentList");
    div.innerHTML = "";
    list.forEach(p => {
        const item = document.createElement("div");
        item.className = "prompt-item";
        item.innerText = p;
        item.onclick = () => { document.getElementById("prompt").value = p; generateReport(); };
        div.appendChild(item);
    });
}

function saveRecent(prompt) {
    let list = JSON.parse(localStorage.getItem("recentPrompts") || "[]");
    list = list.filter(x => x !== prompt);
    list.unshift(prompt);
    list = list.slice(0, 10);
    localStorage.setItem("recentPrompts", JSON.stringify(list));
    loadRecent();
}

/*************************************************
   NORMALIZER
*************************************************/
function normalizeResponse(raw) {
    try {
        if (typeof raw === "string" && (raw.startsWith("{") || raw.startsWith("[")))
            raw = JSON.parse(raw);
    } catch(e){}

    if (Array.isArray(raw) && raw[0]?.json) return raw[0].json;
    if (raw?.json) return raw.json;

    const key = Object.keys(raw || {})[0];
    if (key && key.toLowerCase().includes("object")) return raw[key];

    if (raw?.report_title || raw?.metrics) return raw;

    return { __raw: raw };
}

/*************************************************
   GENERATE REPORT
*************************************************/
document.getElementById("generateBtn").onclick = generateReport;

async function generateReport() {
    const prompt = document.getElementById("prompt").value.trim();
    if (!prompt) return;

    saveRecent(prompt);
    document.getElementById("loader").style.display = "block";
    document.getElementById("reportArea").innerHTML = "";

    const res = await fetch(n8nWebhook, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ prompt })
    });

    const text = await res.text();
    let parsed = text;
    try { parsed = JSON.parse(text); } catch(e){}

    const data = normalizeResponse(parsed);

    document.getElementById("loader").style.display = "none";
    renderReport(prompt, data);
}

/*************************************************
   FLATTEN + Capitalization
*************************************************/
function flatten(obj, prefix = "", out = {}) {
    for (const k in obj) {
        if (typeof obj[k] === "object")
            flatten(obj[k], prefix + k + " - ", out);
        else out[prefix + k] = obj[k];
    }
    return out;
}

function titleCase(str) {
    return str.replace(/_/g," ").replace(/\b\w/g, c => c.toUpperCase());
}

/*************************************************
   RENDER REPORT
*************************************************/
function renderReport(prompt, data) {
    const area = document.getElementById("reportArea");
    area.innerHTML = "";

    const box = document.createElement("div");
    box.className = "report-box";

    box.innerHTML += `
        <details>
            <summary>Prompt Used</summary>
            <div>${prompt}</div>
        </details>
    `;

    const title = data.report_title || data.title || "Report";
    const summary = data.summary || "";
    box.innerHTML += `<h2>${title}</h2><p>${summary}</p>`;

    /* Metrics */
    if (data.metrics) {
        const flat = flatten(data.metrics);
        box.innerHTML += `<div class="section-title">üìä Metrics Overview</div>`;
        for (const k in flat) {
            box.innerHTML += `
                <div class="metric-item">
                    <span>${titleCase(k)}</span>
                    <strong>${flat[k]}</strong>
                </div>
            `;
        }

        box.innerHTML += `
            <div class="section-title">üìà Visualization</div>
            <div class="chart-wrapper">
                <canvas id="chart"></canvas>
            </div>
        `;

        setTimeout(() => drawChart(flat), 60);
    }

    /* Actions */
    const actions = data.recommended_actions || data.actions || [];
    if (actions.length > 0) {
        box.innerHTML += `
            <div class="section-title">üí° Recommended Actions</div>
            <ul>${actions.map(a => `<li>${a}</li>`).join("")}</ul>
        `;
    }

    area.appendChild(box);
}

/*************************************************
   DRAW CHART
*************************************************/
function drawChart(metrics) {
    const ctx = document.getElementById("chart")?.getContext("2d");
    if (!ctx) return;

    const labels = Object.keys(metrics).map(titleCase);
    const values = Object.values(metrics).map(v => Number(v) || 0);

    if (window._chart) window._chart.destroy();

    window._chart = new Chart(ctx, {
        type: "pie",
        data: {
            labels,
            datasets: [{
                data: values,
                backgroundColor: ["#1564FF","#4BA3FF","#8EC8FF","#5DD39E","#35A785","#FFB26B"]
            }]
        },
        options: { responsive:true }
    });
}

/*************************************************
   EXPORT PDF
*************************************************/
document.getElementById("pdfBtn").onclick = () => {
    if (!document.getElementById("reportArea").innerHTML.trim())
        return alert("No report to export");
    html2pdf().from(document.getElementById("reportArea")).save();
};

/*************************************************
   RESET
*************************************************/
document.getElementById("resetBtn").onclick = () => {
    document.getElementById("prompt").value = "";
    document.getElementById("reportArea").innerHTML = "";
};

loadRecent();
</script>

</body>
</html>
