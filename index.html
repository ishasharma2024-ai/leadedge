<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>AI Copilot â€” Prompt to Report</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- jsPDF for PDF export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    /* ---------------------------------------------------------
       LEADSQUARED THEME â€” GLOBAL STYLING
    --------------------------------------------------------- */

    body {
      margin: 0;
      background: #F3F4F6;
      font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto;
      color: #1B1F24;
    }

    /* ---------------------------------------------------------
       HEADER BAR (Matches LSQ Top Navigation)
    --------------------------------------------------------- */
    #lsq-header {
      background: #1564FF;
      color: white;
      padding: 18px 32px;
      font-size: 20px;
      font-weight: 600;
      box-shadow: 0px 2px 10px rgba(0,0,0,0.10);
    }

    /* ---------------------------------------------------------
       MAIN CONTAINER
    --------------------------------------------------------- */
    .container {
      max-width: 1080px;
      margin: 30px auto;
      background: white;
      padding: 28px 40px;
      border-radius: 14px;
      box-shadow: 0px 4px 14px rgba(0,0,0,0.05);
    }

    /* Prompt + Button */
    #input-row {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
    }

    #prompt-box {
      flex: 1;
      padding: 14px;
      font-size: 15px;
      border-radius: 8px;
      border: 1px solid #D1D5DB;
    }

    #submit-btn {
      padding: 14px 20px;
      background: #1564FF;
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
    }
    #submit-btn:hover { opacity: 0.85; }

    /* ---------------------------------------------------------
       METRIC CARDS
    --------------------------------------------------------- */
    .metric-card {
      background: #F9FAFB;
      border: 1px solid #E5E7EB;
      border-radius: 10px;
      padding: 14px 16px;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
    }

    .metric-label { font-size: 15px; font-weight: 500; color: #374151; }
    .metric-value { font-size: 16px; font-weight: 700; color: #1564FF; }

    .section-title {
      font-weight: 600;
      font-size: 17px;
      color: #1F2937;
      margin: 25px 0 10px;
    }

    /* ---------------------------------------------------------
       ANIMATED LOADING SPINNER (LSQ BLUE)
    --------------------------------------------------------- */
    #loader {
      display: none;
      margin-top: 20px;
      text-align: center;
    }

    .spinner {
      border: 4px solid #E5E7EB;
      border-top: 4px solid #1564FF;
      border-radius: 50%;
      width: 42px;
      height: 42px;
      animation: spin 1s linear infinite;
      margin: auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* ---------------------------------------------------------
       PDF BUTTON â€” LSQ STYLING
    --------------------------------------------------------- */
    #pdf-btn {
      margin-top: 20px;
      padding: 12px 18px;
      background: #10B981;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
    }
    #pdf-btn:hover { opacity: 0.85; }
  </style>
</head>

<body>

  <!-- LSQ HEADER -->
  <div id="lsq-header">AI Copilot â€” Prompt to Report</div>

  <div class="container">

    <!-- Input Row -->
    <div id="input-row">
      <input id="prompt-box" placeholder="e.g. Show leakage by provider for last 3 months" />
      <button id="submit-btn">Generate</button>
    </div>

    <!-- LOADING ANIMATION -->
    <div id="loader"><div class="spinner"></div><p>Generating report...</p></div>

    <!-- REPORT SECTION -->
    <div id="report-section" style="display:none;">
      <div id="report-title"></div>
      <div id="report-summary"></div>

      <div class="section-title">ðŸ“Š Metrics Overview</div>
      <div id="report-metrics"></div>

      <div class="section-title">ðŸ“ˆ Visualization</div>
      <canvas id="report-chart"></canvas>

      <div class="section-title">ðŸ§­ Recommended Actions</div>
      <ul id="report-actions"></ul>

      <button id="pdf-btn">â¬‡ Download PDF</button>

    </div>

  </div>


<script>
const n8nWebhook = "https://leadsquared.app.n8n.cloud/webhook/38fe1165-731f-438b-81df-5bc5de35481c";

const submitBtn = document.getElementById('submit-btn');
const promptBox = document.getElementById('prompt-box');
const loader = document.getElementById('loader');
const reportSection = document.getElementById('report-section');
const reportTitle = document.getElementById('report-title');
const reportSummary = document.getElementById('report-summary');
const reportMetrics = document.getElementById('report-metrics');
const reportActions = document.getElementById('report-actions');
let chartInstance = null;

submitBtn.onclick = async () => {
  const prompt = promptBox.value.trim();
  if (!prompt) return alert("Please enter a prompt.");

  submitBtn.disabled = true;
  loader.style.display = "block";
  reportSection.style.display = "none";

  try {
    const resp = await fetch(n8nWebhook, {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({ prompt })
    });

    const text = await resp.text();
    let data = JSON.parse(text);

    if (data && typeof data === "object" && data["object Object"]) {
      data = data["object Object"];
    }

    const report = Array.isArray(data) ? data[0] : data;
    renderReport(report);

  } catch (err) {
    alert("Error: " + err.message);
  }

  submitBtn.disabled = false;
  loader.style.display = "none";
};

function renderReport(data) {
  reportSection.style.display = "block";
  reportTitle.innerHTML = `<h2>${data.report_title}</h2>`;
  reportSummary.innerHTML = `<p>${data.summary}</p>`;

  // Metrics
  reportMetrics.innerHTML = "";
  const flat = flattenMetrics(data.metrics);
  Object.entries(flat).forEach(([k,v]) => {
    reportMetrics.innerHTML += `
      <div class="metric-card">
        <div class="metric-label">${k}</div>
        <div class="metric-value">${v}</div>
      </div>`;
  });

  // Chart
  const labels = Object.keys(flat);
  const values = Object.values(flat);

  if (chartInstance) chartInstance.destroy();
  const ctx = document.getElementById("report-chart");

  chartInstance = new Chart(ctx, {
    type: labels.length <= 6 ? "pie" : "bar",
    data: {
      labels,
      datasets: [{
        data: values,
        backgroundColor: ["#1564FF", "#60A5FA", "#93C5FD", "#A7F3D0", "#34D399", "#10B981"]
      }]
    }
  });

  // Actions
  reportActions.innerHTML = "";
  (data.recommended_actions || []).forEach(a => {
    reportActions.innerHTML += `<li>${a}</li>`;
  });
}

// Flatten metrics
function flattenMetrics(obj, out = {}, prefix = "") {
  for (const [k,v] of Object.entries(obj || {})) {
    const label = prefix ? `${prefix} - ${k}` : k;
    if (typeof v === "number") out[label] = v;
    else if (typeof v === "object") flattenMetrics(v, out, label);
  }
  return out;
}

/* --------------------------------------------------------
   PDF Export
--------------------------------------------------------- */
document.getElementById("pdf-btn").onclick = () => {
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF();
  pdf.text("AI Copilot Report", 14, 14);
  pdf.addHTML(document.querySelector(".container"), () => {
    pdf.save("report.pdf");
  });
};
</script>

</body>
</html>
