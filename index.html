<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>AI Copilot â€” Prompt to Report</title>

    <!-- ChartJS -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- html2pdf -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>

    <style>
        body {
            margin: 0; padding: 0;
            background: #F5F7FA;
            font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto;
            color: #1A1D24;
        }

        /* BLUE STRIP HEADER */
        .header-strip {
            width: 100%;
            background: #1564FF;
            color: white;
            padding: 18px 28px;
            font-size: 20px;
            font-weight: 600;
        }

        /* MAIN LAYOUT */
        .main-layout { display: flex; height: calc(100vh - 60px); }

        /* LEFT: Recent Prompts */
        .left-panel {
            width: 270px; background: white;
            border-right: 1px solid #E4E7EC;
            padding: 20px 16px; overflow-y: auto;
        }

        .left-title { font-size: 15px; font-weight: 600; margin-bottom: 10px; }

        .prompt-item {
            background: #F3F6FC; padding: 10px 12px;
            border-radius: 6px; margin-bottom: 8px;
            font-size: 14px; cursor: pointer;
        }

        .prompt-item:hover { background: #e8f0ff; }

        /* MAIN CONTENT */
        .content-area { flex: 1; padding: 30px; overflow-y: auto; }

        .input-row { display: flex; gap: 12px; margin-bottom: 25px; }

        #prompt {
            width: 100%; padding: 14px;
            border-radius: 8px; border: 1px solid #D0D5DD;
            font-size: 15px;
        }

        #generateBtn {
            background: #1564FF; color: white;
            border: none; padding: 0 22px;
            border-radius: 8px; font-size: 15px;
            cursor: pointer;
        }

        /* TOOLBAR */
        .toolbar {
            display: flex; justify-content: flex-end;
            gap: 12px; margin-bottom: 12px;
        }

        .btn-reset { padding: 8px 18px; background: #E4E7EC; border-radius: 6px; border: none; cursor: pointer; }
        .btn-pdf { padding: 8px 18px; background: #1564FF; color: white; border-radius: 6px; border: none; cursor: pointer; }

        /* REPORT BOX */
        .report-box {
            background: white; border-radius: 10px;
            padding: 28px; box-shadow: 0 2px 6px rgba(0,0,0,0.07);
            margin-bottom: 40px;
        }

        .section-title {
            font-size: 17px; font-weight: 600;
            margin: 20px 0 10px 0;
            display: flex; align-items: center; gap: 6px;
        }

        .metric-item {
            padding: 10px 14px; background: #F9FAFB;
            border: 1px solid #E4E7EC; border-radius: 6px;
            margin-bottom: 8px; display: flex; justify-content: space-between;
        }

        /* SHIMMER LOADING */
        .shimmer {
            height: 140px; border-radius: 8px;
            background: linear-gradient(90deg, #f0f0f0 0%, #e4e4e4 50%, #f0f0f0 100%);
            background-size: 200% 100%; animation: shimmer 1.5s infinite;
            margin-bottom: 20px;
        }

        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

    </style>
</head>

<body>

    <div class="header-strip">AI Copilot â€” Prompt to Report</div>

    <div class="main-layout">

        <!-- LEFT (RECENT) -->
        <div class="left-panel">
            <div class="left-title">Recent Prompts</div>
            <div id="recentList"></div>
        </div>

        <!-- RIGHT (CONTENT) -->
        <div class="content-area">

            <div class="input-row">
                <input id="prompt" placeholder="e.g. Show leakage by provider for last 3 months" />
                <button id="generateBtn">Generate</button>
            </div>

            <div class="toolbar">
                <button class="btn-reset" id="resetBtn">Reset</button>
                <button class="btn-pdf" id="pdfBtn">Download PDF</button>
            </div>

            <div id="loader" style="display:none;">
                <div class="shimmer"></div>
                <div class="shimmer" style="height:80px;"></div>
            </div>

            <div id="reportArea"></div>

        </div>
    </div>

<script>

/* ==================================
   CONFIG
================================== */
const n8nWebhook = "https://leadsquared.app.n8n.cloud/webhook/38fe1165-731f-438b-81df-5bc5de35481c";

/* ==================================
   RECENT PROMPTS
================================== */
function loadRecent() {
    const list = JSON.parse(localStorage.getItem("recentPrompts") || "[]");
    const div = document.getElementById("recentList");
    div.innerHTML = "";
    list.forEach(p => {
        const item = document.createElement("div");
        item.className = "prompt-item";
        item.innerText = p;
        item.onclick = () => { document.getElementById("prompt").value = p; generateReport(); };
        div.appendChild(item);
    });
}

function saveRecent(prompt) {
    let list = JSON.parse(localStorage.getItem("recentPrompts") || "[]");
    list = list.filter(x => x !== prompt);
    list.unshift(prompt);
    list = list.slice(0, 10);
    localStorage.setItem("recentPrompts", JSON.stringify(list));
    loadRecent();
}

/* ==================================
   GENERATE REPORT
================================== */
document.getElementById("generateBtn").onclick = generateReport;

async function generateReport() {
    const prompt = document.getElementById("prompt").value.trim();
    if (!prompt) return;

    saveRecent(prompt);

    document.getElementById("reportArea").innerHTML = "";
    document.getElementById("loader").style.display = "block";

    try {
        const res = await fetch(n8nWebhook, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ prompt })
        });

        const data = await res.json();
        document.getElementById("loader").style.display = "none";

        renderReport(prompt, data);

    } catch(e) {
        document.getElementById("loader").style.display = "none";
        document.getElementById("reportArea").innerHTML =
            "<div style='color:red'>Error contacting server.</div>";
    }
}

/* ==================================
   FLATTEN METRICS (Handles nested objects)
================================== */
function flattenMetrics(obj, prefix = "", result = {}) {
    for (const key in obj) {
        const value = obj[key];
        if (typeof value === "object" && value !== null) {
            flattenMetrics(value, prefix + key + " - ", result);
        } else {
            result[prefix + key] = value;
        }
    }
    return result;
}

/* ==================================
   RENDER REPORT
================================== */
function renderReport(prompt, data) {

    const area = document.getElementById("reportArea");
    area.innerHTML = "";

    const box = document.createElement("div");
    box.className = "report-box";

    /* Collapsible prompt */
    box.innerHTML += `
        <details>
            <summary>Prompt Used</summary>
            <div>${prompt}</div>
        </details>
    `;

    /* Title & Summary */
    box.innerHTML += `
        <h2>${data.report_title || "Report"}</h2>
        <p>${data.summary || ""}</p>
    `;

    /* Metrics */
    if (data.metrics) {
        const flat = flattenMetrics(data.metrics);

        box.innerHTML += `<div class="section-title">ðŸ“Š Metrics Overview</div>`;

        for (const k in flat) {
            box.innerHTML += `
                <div class="metric-item">
                    <span>${k.replace(/_/g," ")}</span>
                    <strong>${flat[k]}</strong>
                </div>
            `;
        }

        /* Chart */
        box.innerHTML += `
            <div class="section-title">ðŸ“ˆ Visualization</div>
            <canvas id="chart" height="260"></canvas>
        `;

        setTimeout(() => drawChart(flat), 50);
    }

    /* Recommended Actions */
    if (data.recommended_actions) {
        box.innerHTML += `
            <div class="section-title">ðŸ’¡ Recommended Actions</div>
            <ul>${data.recommended_actions.map(a => `<li>${a}</li>`).join("")}</ul>
        `;
    }

    area.appendChild(box);
}

/* ==================================
   DRAW CHART
================================== */
function drawChart(metrics) {
    const ctx = document.getElementById("chart").getContext("2d");

    new Chart(ctx, {
        type: "pie",
        data: {
            labels: Object.keys(metrics),
            datasets: [{
                data: Object.values(metrics),
                backgroundColor: ["#1564FF", "#4BA3FF", "#8EC8FF", "#5DD39E", "#35A785", "#FFB26B"]
            }]
        },
        options: { responsive: true }
    });
}

/* ==================================
   PDF EXPORT
================================== */
document.getElementById("pdfBtn").onclick = function () {
    const element = document.getElementById("reportArea");
    html2pdf().from(element).save("report.pdf");
};

/* ==================================
   RESET
================================== */
document.getElementById("resetBtn").onclick = function () {
    document.getElementById("prompt").value = "";
    document.getElementById("reportArea").innerHTML = "";
};

/* Load recent on start */
loadRecent();

</script>

</body>
</html>
